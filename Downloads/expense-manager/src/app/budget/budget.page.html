<ion-header [translucent]="true">
  <ion-toolbar>
    <div class="toolbar-container">
      <div class="month-toggler-container">
        <ion-buttons slot="start">
          <ion-button (click)="toggleMonth('back')" color="white" id="back-btn">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-text id="wrapped-title">{{ currentMonth.display }}</ion-text>
        <ion-buttons slot="end">
          <ion-button (click)="toggleMonth('forward')" color="white" id="forward-btn">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </div>
      
      <ion-button color="white" id="personalized-budget" (click)="generatePersonalizedBudget()" [disabled]="!! response">
        
        @if (!generating) {
          <ion-icon name="bulb-outline" id="bulb-icon"></ion-icon>
        Get Personalized budget
        }
        @else {
          <ion-spinner name="crescent" color="black" class="button-spinner"></ion-spinner>
          Generating...
        }
      </ion-button>
  </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
 
  @if (response) {
  <div class="advice-popup">
    <div class="popup-content">
      <div class="popup-header">
      <ion-title id="report-title">Result</ion-title>
    </div>
      <ion-icon name="close" id="close-icon" color="danger" (click)="closePopup()"></ion-icon>
      After analyzing your financial and personal information, this is what your budget should look like: 
      <ion-grid >
        <ion-row class="header-row">
          <ion-col class="header-cell">Category</ion-col>
          <ion-col class="header-cell">Amount</ion-col>
        </ion-row>
        @for (spending of (advisedBudget.spendings | keyvalue); track $index) {
          <ion-row class="data-row">
            <ion-col class="data-cell">{{spending.key}}</ion-col>
            <ion-col class="data-cell">{{spending.value | currency}}</ion-col>
          </ion-row>
        }
        <ion-row class="total-row">
          <ion-col class="data-cell"><strong>Total</strong></ion-col>
          <ion-col class="data-cell"><strong>{{ advisedBudget.totalBudget| currency }}</strong></ion-col>
        </ion-row>
      </ion-grid>
      <div id="action-btns">
        <ion-button (click)="saveAdvisedBudget()">Save</ion-button>
        <ion-button color="danger" (click)="closePopup()">Discard</ion-button>
      </div>
    </div>
  </div>
}
  <div class="content-wrapper">
    
    
    
    @if (!loading) {
    @if ((filteredBudgets$ | async) ; as budget) {
    <h2 id="budget-title">Monthly Budget: month {{currentMonth.value + 1}} of year {{selectedDate.getFullYear()}}</h2>
    <ion-grid class="table" [ngClass]="{'glow-effect': setBudget.shouldGlow, 'no-glow': !setBudget.shouldGlow}" #budgetTable>
      <ion-row class="header-row">
        <ion-col class="header-cell">Category</ion-col>
        <ion-col class="header-cell">Amount</ion-col>
      </ion-row>
      <ion-row *ngFor="let spending of (budget.spendings | keyvalue)" class="data-row">
        <ion-col class="data-cell">{{ spending.key }}</ion-col>
        <ion-col class="data-cell">{{ spending.value | currency : 'USD' : 'symbol' : '1.2-2' : 'en' }}</ion-col>
      </ion-row>
      <ion-row class="total-row">
        <ion-col class="data-cell"><strong>Total</strong></ion-col>
        <ion-col class="data-cell"><strong>{{ budget.totalBudget| currency }}</strong></ion-col>
      </ion-row>
    </ion-grid>
    } @else {
    <div class="no-data">No budget data available</div>
    }
    }@else {
    <ion-spinner name="crescent" id="spinner"></ion-spinner>
    }
  </div>
  
  @if (!loading) {
    
  
    @if ((filteredCurrentBudget$ | async) ; as currentBudget) {
      @if ((currentBudget.spendings | keyvalue).length > 0) {
      <ion-item-divider class="budget-divider">
        <ion-label id="budget-usage">Budget Usage</ion-label>
        <div class="progress-container">
          <div class="progress-bar">
          
            <div 
              class="progress-fill" 
              [ngStyle]="{'background-color': getBudgetColor(currentBudget)}"
              [style.width.%]= "(setBudget.totalBudget ? (currentBudget.totalBudget/ setBudget.totalBudget)* 100 : 0)">
            </div>
          </div>
          
        </div>
        <p class="progress-text">
          <strong [ngStyle]="{'color': getBudgetColor(currentBudget)}">
            {{ toScientificNotation(getFormattedPercentage(currentBudget)) | number:'1.2-2'}}%
          </strong>
         </p>
      </ion-item-divider>
      <ion-grid class="table">
        <ion-row class="header-row">
          <ion-col class="header-cell"><strong>Category</strong></ion-col>
          <ion-col class="header-cell"><strong>Amount</strong></ion-col>
        </ion-row>
    
        <ion-row *ngFor="let spending of (currentBudget.spendings| keyvalue)" class="data-row">
          <ion-col class="data-cell"
          [ngStyle]="{'color': getSpendingColor(spending.key, spending.value, currentBudget)}">
          {{ spending.key }}
        </ion-col>
          <ion-col class="data-cell" [ngStyle]="{'color': getSpendingColor(spending.key, spending.value, currentBudget)}"
         
          >
          {{ (spending.value)|currency }}</ion-col>
       
        </ion-row>
        <ion-row class="total-row"
        [ngClass]="
        {'deficit-total': currentBudget.totalBudget < setBudget.totalBudget,
        'surplus-total': currentBudget.totalBudget > setBudget.totalBudget}">
          <ion-col class="data-cell"><strong>Total</strong></ion-col>
          <ion-col class="data-cell"><strong>{{ (currentBudget.totalBudget)|currency }}</strong></ion-col>
        </ion-row>
      </ion-grid>
    }@else {
      <div class="no-data current">No current data available</div>
      }
      
      } @else {
      <div class="no-data current">No current data available</div>
      }
    } @else {
    <ion-spinner name="crescent" id="spinner"></ion-spinner>
    }
  <div id="fab-container">
    <ion-fab vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button routerLink="/add-budget" routerDirection="forward">
        <ion-icon [src]="'../../assets/add.svg'"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  </div>
</ion-content>


<style>
  ion-header, ion-toolbar {
    --background: #007aff;
    color: white;
  }
  .budget-divider {
  --background: #007aff;
  --color: white;
  text-align: center;
  font-weight: bold;
  font-size: 1.2rem;
  display: flex;
  gap: 30px;
  justify-content: space-around !important;
  margin-top: 15px;
}

#toggler {
  justify-self: flex-end !important;
  margin-left: auto;
}

  .month-toggler-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
  }

  #wrapped-title {
    font-size: 1.4rem;
    font-weight: bold;
    text-align: center;
  }

  ion-content {
    --background: #f8f9fa;
    padding-bottom: 70px;
  }

  .content-wrapper {
    padding: 16px;
  }

  #budget-title {
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
  }

  .table {
    border-radius: 10px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 10px;
  }

  .header-row {
    background: #007aff;
    color: white;
    font-weight: bold;
    text-align: center;
  }

  .data-row {
    transition: background-color 0.3s;
  }

  .data-row:hover {
    background: #f1f1f1;
  }

  .total-row {
    background: #e1e1e1;
    font-weight: bold;
  }

  .data-cell {
    padding: 12px;
    text-align: center;
  }

  .no-data {
    text-align: center;
    color: #888;
    font-size: 16px;
    padding: 20px;
  }

  #spinner {
    display: block;
    margin: 30px auto;
  }

  #fab-container {
    position: fixed;
    bottom: 10px;
  }
</style>
